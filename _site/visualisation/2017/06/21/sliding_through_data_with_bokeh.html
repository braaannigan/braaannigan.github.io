<script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<h2 id="exploring-parameter-space-smoothly">Exploring parameter space smoothly</h2>
<p>Tim Hopper has written a great <a href="http://pythonplot.com/">post</a> about exploratory data analysis using a
variety of libraries that wrap matplotlib. Something that can really help exploratory
data analysis are dynamic plots that allow you to easily scan through a multidimensional
parameter space without having to replot your data every time.</p>

<p>Slider tools are very handy for this - if creating the slider widget is easier than
doing the replotting.  The <a href="https://github.com/bokeh/bokeh">Bokeh</a> plot library in python is built with just this
kind of interactivity in mind.  The code below creates two synthetic data series
that are lagged in time by 12 months.  Going beyond the basic scatter plot, I’ve
also added in a linear regression line calculated using sci-kit learn’s linear regression
and a text annotation with the R^2 coefficient of determination. This simple
set up satisfies both requirements to be useful - the data exploration with the
slider is smooth while the code is straightforward to write.</p>

<p>To run the code, you’ll need to have Bokeh installed through conda/pip
as well as the standard python packages numpy/pandas/sci-kit learn.
Save the code below to a script called sliders_ex.py.  Then
in the bash command line from the directory with the script you run $bokeh serve –show sliders_ex.py.  The plot should
open up automatically in your browser at http://localhost:5006/sliders_ex</p>

<p>This kind of interactivity is also available with a matplotlib backend through the
exciting <a href="holoviews.org">holoviews</a> package.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">#</span><span class="n">Data</span> <span class="k">imports</span>
<span class="n">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="k">from</span> <span class="n">sklearn</span><span class="p">.</span><span class="n">linear_model</span> <span class="n">import</span> <span class="n">LinearRegression</span>
<span class="k">from</span> <span class="n">sklearn</span><span class="p">.</span><span class="n">metrics</span> <span class="n">import</span> <span class="n">r2_score</span>
<span class="p">#</span><span class="n">Bokeh</span> <span class="k">imports</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">io</span> <span class="n">import</span> <span class="n">curdoc</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">glyphs</span> <span class="n">import</span> <span class="n">Text</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">layouts</span> <span class="n">import</span> <span class="n">row</span><span class="p">,</span> <span class="n">widgetbox</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="n">ColumnDataSource</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">widgets</span> <span class="n">import</span> <span class="n">Slider</span><span class="p">,</span> <span class="n">TextInput</span>
<span class="k">from</span> <span class="n">bokeh</span><span class="p">.</span><span class="n">plotting</span> <span class="n">import</span> <span class="n">figure</span>

<span class="p">#</span><span class="n">Create</span> <span class="n">datasets</span>
<span class="n">t</span> <span class="p">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">120</span><span class="p">,</span><span class="m">120</span><span class="p">)</span> <span class="p">#</span><span class="n">Ten</span> <span class="n">years</span> <span class="k">in</span> <span class="n">months</span>
<span class="n">freq</span> <span class="p">=</span> <span class="m">2.</span><span class="p">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">/</span><span class="m">18</span> <span class="p">#</span><span class="n">One</span> <span class="n">cycle</span> <span class="n">every</span> <span class="m">18</span> <span class="n">months</span>
<span class="n">x_in</span> <span class="p">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">cos</span><span class="p">(</span><span class="n">freq</span><span class="p">*</span><span class="n">t</span><span class="p">)</span> <span class="p">#</span>
<span class="n">y_in</span> <span class="p">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">cos</span><span class="p">(</span><span class="n">freq</span><span class="p">*</span><span class="n">t</span> <span class="p">+</span> <span class="m">2</span><span class="p">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">*(</span><span class="m">0.33</span><span class="p">))</span> <span class="p">+</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">random</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">t</span><span class="p">))-</span><span class="m">0.5</span><span class="p">)</span> <span class="p">#</span><span class="n">Lagged</span> <span class="n">by</span> <span class="m">6</span> <span class="n">months</span>
<span class="n">df</span> <span class="p">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'t'</span><span class="p">:</span><span class="n">t</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">:</span><span class="n">x_in</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">:</span><span class="n">y_in</span><span class="p">})</span>

<span class="n">def</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="s2">"""Calculate the linear regression and r2 score"""</span>
    <span class="k">model</span> <span class="p">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="k">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">][:,</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span>
    <span class="p">#</span><span class="n">Get</span> <span class="n">the</span> <span class="n">x</span><span class="p">-</span> <span class="k">and</span> <span class="n">y</span><span class="p">-</span><span class="n">values</span> <span class="n">for</span> <span class="n">the</span> <span class="n">best</span> <span class="n">fit</span> <span class="n">line</span>
    <span class="n">x_plot</span> <span class="p">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(-</span><span class="n">ax_lim</span><span class="p">,</span><span class="n">ax_lim</span><span class="p">)</span>
    <span class="n">y_plot</span> <span class="p">=</span> <span class="k">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_plot</span><span class="p">[:,</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="p">#</span><span class="n">Calculate</span> <span class="n">the</span> <span class="n">r2</span> <span class="n">score</span>
    <span class="n">r2</span> <span class="p">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">],</span><span class="k">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">][:,</span><span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]))</span>
    <span class="p">#</span><span class="n">Position</span> <span class="n">for</span> <span class="n">the</span> <span class="n">r2</span> <span class="n">text</span> <span class="n">annotation</span>
    <span class="n">r2_x</span> <span class="p">=</span> <span class="p">[-</span><span class="n">ax_lim</span> <span class="p">+</span> <span class="m">0.1</span><span class="p">*</span><span class="n">ax_lim</span><span class="p">]</span>
    <span class="n">r2_y</span> <span class="p">=</span> <span class="p">[</span><span class="n">ax_lim</span> <span class="p">-</span> <span class="m">0.1</span><span class="p">*</span><span class="n">ax_lim</span><span class="p">]</span>
    <span class="n">text</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"R^2 = %02f"</span> <span class="p">%</span> <span class="n">r2</span><span class="p">]</span>
    <span class="n">return</span> <span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r2_x</span><span class="p">,</span> <span class="n">r2_y</span><span class="p">,</span> <span class="n">text</span>

<span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r2_x</span><span class="p">,</span> <span class="n">r2_y</span><span class="p">,</span> <span class="n">text</span> <span class="p">=</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">#</span><span class="k">Set</span> <span class="n">the</span> <span class="n">ColumnDataSource</span> <span class="n">for</span> <span class="n">the</span> <span class="n">plot</span>
<span class="n">source</span> <span class="p">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="p">=</span><span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">],</span> <span class="n">y</span><span class="p">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]))</span> <span class="p">#</span><span class="n">Scatter</span> <span class="n">plot</span>
<span class="n">text_source</span> <span class="p">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">r2_x</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="n">r2_y</span><span class="p">,</span> <span class="n">text</span><span class="p">=</span><span class="n">text</span><span class="p">))</span> <span class="p">#</span><span class="n">R2</span> <span class="n">value</span>
<span class="n">line_source</span> <span class="p">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="p">=</span><span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="n">y_plot</span><span class="p">))</span> <span class="p">#</span><span class="n">Regression</span> <span class="n">line</span>

<span class="p">#</span> <span class="k">Set</span> <span class="n">up</span> <span class="n">initial</span> <span class="n">plot</span>
<span class="n">ax_lim</span> <span class="p">=</span> <span class="m">1.1</span><span class="p">*</span><span class="n">np</span><span class="p">.</span><span class="k">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="k">array</span><span class="p">([</span><span class="n">x_in</span><span class="p">,</span><span class="n">y_in</span><span class="p">])))</span> <span class="p">#</span><span class="n">Axis</span> <span class="n">limits</span>
<span class="n">plot</span> <span class="p">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">plot_height</span><span class="p">=</span><span class="m">900</span><span class="p">,</span> <span class="n">plot_width</span><span class="p">=</span><span class="m">900</span><span class="p">,</span> <span class="n">title</span><span class="p">=</span><span class="s2">"Lagged scatter plot"</span><span class="p">,</span>
              <span class="n">tools</span><span class="p">=</span><span class="s2">"crosshair,pan,reset,save,wheel_zoom"</span><span class="p">,</span>
              <span class="n">x_range</span><span class="p">=[-</span><span class="n">ax_lim</span><span class="p">,</span> <span class="n">ax_lim</span><span class="p">],</span>
              <span class="n">y_range</span><span class="p">=[-</span><span class="n">ax_lim</span><span class="p">,</span> <span class="n">ax_lim</span><span class="p">])</span>

<span class="n">plot</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="n">source</span><span class="p">=</span><span class="n">source</span><span class="p">)</span>
<span class="n">plot</span><span class="p">.</span><span class="n">line</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="n">source</span> <span class="p">=</span> <span class="n">line_source</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="s1">'black'</span><span class="p">)</span>
<span class="n">glyph</span> <span class="p">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="s2">"y"</span><span class="p">,</span> <span class="n">text</span><span class="p">=</span><span class="s2">"text"</span><span class="p">,</span> <span class="n">text_color</span><span class="p">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">plot</span><span class="p">.</span><span class="n">add_glyph</span><span class="p">(</span><span class="n">text_source</span><span class="p">,</span> <span class="n">glyph</span><span class="p">)</span>
<span class="n">plot</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="n">axis_label</span> <span class="p">=</span> <span class="s1">'X'</span>
<span class="n">plot</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="n">axis_label</span> <span class="p">=</span> <span class="s1">'Y'</span>

<span class="p">#</span> <span class="k">Set</span> <span class="n">up</span> <span class="n">slider</span>
<span class="n">offset</span> <span class="p">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">title</span><span class="p">=</span><span class="s2">"Lag in months"</span><span class="p">,</span> <span class="n">value</span><span class="p">=</span><span class="m">0</span><span class="p">,</span> <span class="n">start</span><span class="p">=-</span><span class="m">30</span><span class="p">,</span> <span class="k">end</span><span class="p">=</span><span class="m">30</span><span class="p">,</span> <span class="n">step</span><span class="p">=</span><span class="m">1</span><span class="p">)</span>

<span class="p">#</span><span class="n">Update</span> <span class="n">the</span> <span class="n">plot</span> <span class="k">as</span> <span class="n">the</span> <span class="n">slider</span> <span class="n">changes</span>
<span class="n">def</span> <span class="n">update_data</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
    <span class="p">#</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">new</span> <span class="n">slider</span> <span class="n">value</span> <span class="n">for</span> <span class="n">the</span> <span class="n">lag</span>
    <span class="n">lag</span> <span class="p">=</span> <span class="n">offset</span><span class="p">.</span><span class="n">value</span>
    <span class="p">#</span> <span class="n">Generate</span> <span class="n">the</span> <span class="n">dataframe</span> <span class="n">for</span> <span class="n">the</span> <span class="n">new</span> <span class="n">plot</span>
    <span class="n">df</span> <span class="p">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">lag</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="p">=</span> <span class="n">x_in</span><span class="p">[:-</span><span class="n">lag</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="p">=</span> <span class="n">y_in</span><span class="p">[</span><span class="n">lag</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">lag</span> <span class="p">==</span> <span class="m">0</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="p">=</span> <span class="n">x_in</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="p">=</span> <span class="n">y_in</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="p">=</span> <span class="n">x_in</span><span class="p">[-</span><span class="n">lag</span><span class="p">:]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="p">=</span> <span class="n">y_in</span><span class="p">[:</span><span class="n">lag</span><span class="p">]</span>
    <span class="p">#</span><span class="n">Update</span> <span class="n">the</span> <span class="n">linear</span> <span class="n">regression</span> <span class="n">values</span>
    <span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r2_x</span><span class="p">,</span> <span class="n">r2_y</span><span class="p">,</span> <span class="n">text</span> <span class="p">=</span> <span class="n">linear_regression</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="p">#</span><span class="n">Update</span> <span class="n">the</span> <span class="n">plot</span>
    <span class="n">text_source</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">r2_x</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="n">r2_y</span><span class="p">,</span> <span class="n">text</span> <span class="p">=</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">source</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'x'</span><span class="p">],</span> <span class="n">y</span><span class="p">=</span><span class="n">df</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span>
    <span class="n">line_source</span><span class="p">.</span><span class="n">data</span> <span class="p">=</span> <span class="n">dict</span><span class="p">(</span><span class="n">x</span><span class="p">=</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y</span><span class="p">=</span><span class="n">y_plot</span><span class="p">)</span>

<span class="p">#</span><span class="n">Actions</span> <span class="n">when</span> <span class="n">the</span> <span class="n">slider</span> <span class="n">value</span> <span class="n">is</span> <span class="n">changed</span>
<span class="n">offset</span><span class="p">.</span><span class="n">on_change</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="n">update_data</span><span class="p">)</span>

<span class="p">#</span> <span class="k">Set</span> <span class="n">up</span> <span class="n">layouts</span> <span class="k">and</span> <span class="n">add</span> <span class="k">to</span> <span class="n">document</span>
<span class="n">inputs</span> <span class="p">=</span> <span class="n">widgetbox</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="n">curdoc</span><span class="p">().</span><span class="n">add_root</span><span class="p">(</span><span class="n">row</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">width</span><span class="p">=</span><span class="m">800</span><span class="p">))</span>
<span class="n">curdoc</span><span class="p">().</span><span class="n">title</span> <span class="p">=</span> <span class="s2">"Sliders"</span>
</code></pre></div></div>
